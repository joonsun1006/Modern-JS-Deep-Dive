# CHAP 38 - 브라우저의 렌더링 과정

## 브라우저 렌러링 과정 요약

1. HTML을 파싱하여 `DOM 트리 구축`
   - link 태그를 만나면 잠시 중단하여 CSSOM 트리 구축
   - script태그를 만나면 잠시 중단하여 JS파싱.
2. CSS를 파싱하여 `CSSOM 트리 구축`
3. DOM트리 와 CSSOM 트리 결합을 통해 `렌더 트리를 구축.`
4. JS엔진은 JS코드를 파싱하여 `AST`를 만들고, `바이트 코드로 변환하여 실행`.
   - 이때 DOM API를 통해 DOM 이나 CSSOM을 변경할 수 있음.
   - 변경된 DOM과 CSSOM은 다시 렌더 트리로 결합됨.
5. 렌더 트리를 기반으로 HTML 요소의 `레이아웃` 계산,브라우저 화면에 HTML요소를 `페인팅`

## 브라우저 렌더링 과정 살펴보기

1. HTML을 파싱해서 DOM트리 생성

   - 렌더링 엔진이 HTML 문서를 수신받으면 HTML 파서는 이를 위에서 부터 읽어 내려가며 파싱을 진행하고 DOM트리를 생성.
   - HTML 파싱 과정
     <img width="627" alt="image" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/3ac186da-be86-4b01-b116-4183f4a2178f">

     1. 서버로부터 `이진수 형태`의 HTML 문서를 응답받는다.

     2. 지정된 인코딩 방식(UTF-8)에 따라 이를 `문자열`로 변환한다.

     ```html
     <meta charset="UTF-8" />
     ```

     3. 변환된 문자열을 `토큰`으로 분해한다.

     4. 토큰을 내용에 따라 `객체(노드)`로 변환한다.

     5. 객체를 **트리 구조**로 구성하여 `DOM`을 생성한다.

   ***

2. CSS 파싱해서 CSSOM 생성

<img width="459" alt="image" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/4091e41d-7a0d-46b5-8ee1-937e7fa98388">

    - HTML 파싱 중 CSS 문서를 가져오는 `link` 태그를 만나면, DOM 생성이 **잠시 중단**되고 해당 CSS의 파싱 과정이 시작된다. CSS 파서는 서버에서 수신받은 CSS 문서를 파싱하여 **CSSOM 트리**를 생성한다.

        CSS 파싱 과정은 기본적으로 HTML 파싱 과정과 동일하다.

    - CSS 파싱 과정
        1. 서버로부터 **`이진수 형태`**의 CSS 문서를 응답받는다.
        2. 지정된 인코딩 방식(UTF-8)에 따라 이를 **`문자열`**로 변환한다.

            ```html
            <meta charset="UTF-8">
            ```

        3. 변환된 문자열을 **`토큰`**으로 분해한다.
        4. 토큰을 내용에 따라 **`객체(노드)`**로 변환한다.
        5. 객체를 **트리 구조**로 구성하여 **`CSSOM`**을 생성한다.
    - CSS 파싱을 완료하면 HTML 파싱이 중단된 지점부터 **다시 HTML을 파싱**하기 시작하여 DOM 생성을 재개한다.

---

1. JavaScript 파싱
   - HTML 파싱 과정에서 `script` 태그를 만나면, 렌더링 엔진은 DOM 생성을 **잠시 중지**하고 서버에서 해당 JavaScript 리소스를 브라우저 엔진으로부터 받아온다. 그리고 **JavaScript 엔진**에게 제어권을 넘겨준다.
   - JavaScript 엔진은 받아온 JS 리소스를 파싱하여 **`AST (추상 구문 트리)`**를 생성하고 인터프리터로 **바이트코드로 변환**해 실행한다.

<img width="635" alt="스크린샷 2024-02-06 오후 3 52 44" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/ac12e6a5-fff4-4873-a4bb-b4c456b40351">

    1. 토크나이징
        - 단순 문자열인 JS코드를 어휘 분석을 해서 토큰들로 분해 한다.
    2. 파싱
        - 토큰들의 집합을 구문 붑석해서 AST를 생성
            - AST를 사용하면 TS, Babel, Prettie같은 트랜스 파일러를 구현 할 수 있다
    3. 바이트코드 생성과 실행
        - AST는 인터프리터가 실행할 수 있는 중간 코드인 바이트코드로 변환 되고 인터프리터에 의해 실행 됨.
            - 참고: v8엔진은 터보팬이라는 컴파일러가 최적화된 머신코드로 컴파일해서 성능을 최적화해줌. 사용 빈도가 적어지는 코드는 다시 deoptimizing함.

    <aside>
    💡 용어 정리
    토큰: 문법적 의미를 가진 코드의 최소 단위.

    AST: 토큰에 문법적 의미와 구조를 반영한 트리구조의 자료구조.

    바이트코드: 인터프리터가 이해할 수 있도록 중간 코드로 컴파일 한 것.

    </aside>

    - JavaScript 파싱이 종료되면 렌더링 엔진은 다시 제어권을 돌려받고 DOM 생성을 이어나간다.

    ** script 태그가 body 태그 내부 최하단에 위치해야하는 이유

    ⇒ 만일 `script` 태그를 `body` 태그의 중간에 작성할 경우, HTML 파싱이 끝나지 않은 상태에서 JavaScript로 인해 DOM이 조작되어 에러가 발생할 위험이 생긴다.

2.  Render Tree 생성
    <img width="656" alt="image" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/1617bf0d-1427-443f-8149-b3f8d3103647">

        - HTML과 CSS의 파싱 과정이 모두 끝나면, 각각의 결과물인 DOM 트리와 CSSSOM 트리를 서로 **결합**하여 **랜더 트리 (Render Tree)**를 생성한다.
        - 이 때 display: none, meta 태그, script태그 등 화면에 보이지 않는 부분은 사라짐. visibillity는 안보이지만 공간을 차지함.

        - **랜더 트리 생성 과정**
            1. `html` 태그와 `body` 태그를 처리하며 **랜더 트리 루트**를 구성한다.
            2. **DOM**의 최상위 노드부터 순회하면서 **화면에 보여지지 않는 노드**를 랜더 트리의 구성에서 제외한다.
            3. 화면에 보여지는 나머지 노드에 **CSSOM** 규칙을 찾아 일치하는 스타일을 적용한다.

                (`position`사용했을 경우, 실제 그려지는 위치로 랜더 객체가 이동한다.)



3.  레이아웃(Layout)
    - 랜더 트리 생성이 끝나면, 전체적인 웹 페이지 화면 안에서 렌더 트리 내 각 노드의 위치, 크기 를 계산하고, 이를 화면에 배치하는 레이아웃 (Layout) 과정이 진행된다. 즉, **렌더 트리의 노드들을 화면에 배치하는 과정이다.**
    - 초기 배치 이후 레이아웃 (Layout) 작업이 다시 일어나는 것을 **리플로우 (Reflow)라고 한다. DOM이 변경 되거나 css 스타일 등 일부 특정 부분만 재배치가 필요할 때 발생한다.**
4.  페인트(Paint)
    - 레이아웃 과정에서 계산된 정보들을 바탕으로 각 노드를 화면에 그려주는 페인트 (Paint) 과정이 진행된다. 페인트는 렌더 트리의 각 노드를 **화면의 실제 픽셀로 변환**해주는 작업이다.

### 레이아웃 계산& 페인팅 재차 실행 되는 경우

<img width="552" alt="스크린샷 2024-02-06 오후 3 56 06" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/f2525fea-d7d9-4526-8b96-8d201c290d96">

1. JS에 의한 노드 추가 또는 삭제 ( 위의 사진 참고)
2. 브라우저 창의 리사이징에 의한 뷰포트 크기 변경
3. HTML요소의 레이아웃(위치,크기)에 변경을 발생시키는 width,height, margin, padding, border, display, position, top right bottom left등 스타일 변경

⇒ layout, painting 을 다시 실행하는 리렌더링은 비용이 많이드는, 성능에 악영향을 주는 작업이다.

가급적 리렌더링이 빈번하게 발생하지 않도록 주의하자.

> 리플로우와 리페인트가 반드시 순차적으로 동시에 실행 되진 않음. 레이아웃에 영향이 없는 변경은 리플로우 없이 리페인트만 실행 됨.

## JS 파싱에 의한 HTML 파싱 중단

- 위의 설명처럼 브라우저는 `동기적`으로, 위에서 아래 방향으로 `순차적으로` HTML, CSS, 자바스크립트를 `파싱하고 실행`한다.
- 이는 `script태그의 위치`에 따라 `HTML 파싱이 블로킹`이 되어 DOM생성이 지연될 수 있다는 것을 의미한다.
- 따라서 script태그의 위치는 중요한 의미를 가짐.

### script 태그가 head 태그 내에 있다면

- DOM이 완성되지 않은 상태에서 JS가 DOM을 조작하면 에러가 발생할 수 있음.
- HTML 파잇이 블로킹이 되어 DOM생성이 지연됨

### script 태그가 body태그 최하단에 있다면

- JS가 실행될 시점에는 이미 렌더링 엔진이 HTML 요소를 모두 파싱하여 DOM생성을 완료한 이후라, 실행 전 DOM을 조작하여 에러가 발생할 우려가 없다.
- JS가 실행되기 전에 DOM 생성이 완료되어 렌더링되어서 페이지 로딩 시간이 단축됨.

## script 태그의 async , defer 어트리뷰트

- JS 파싱에 의한 DOM 생성이 중단 되는 문제를 근보적으로 해결하기 위해서 HTML5 부터 script 태그에 async 와 defer attribute가 추가됨.
- 해당 어트리뷰트는 src 어트리뷰트를 통해 외부 JS 파일을 로드하는 경우에만 사용할 수 있다.

### async

<img width="594" alt="스크린샷 2024-02-06 오후 4 13 17" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/4b3d9238-ec92-4d40-913a-7c10ab703472">

- HTML 파싱과 외부 JS 파일의 로드가 비동기적으로 동시에 진행됨.
- JS 파싱과 실행은 JS 파일의 로드가 완료된 직후 진행 ⇒ HTML 파싱이 중단됨
- 여러 script 태그를 쓴다면, script 태그의 순서와는 상관없이 로드가 완료된 JS부터 먼저 실행되므로 순서가 보장되지 않음.

### defer

<img width="471" alt="스크린샷 2024-02-06 오후 4 13 27" src="https://github.com/somm12/Modern-JS-Deep-Dive/assets/63543733/d24300e0-7579-4cd6-aba4-6f00ab2630b9">

- HTML 파싱과 외부 JS 파일의 로드가 비동기적으로 동시에 진행됨.
- JS 파싱과 실행은 HTML 파싱이 완료 된 직후에 DOM 생성이 완료된 직후에 진행됨.
- 문서에 추가된 순서로 script 태그 js 파일이 실행됨.
